#!/bin/bash

# Pre-commit hook for Contextune Music Player Plugin
# This script runs code formatting and basic checks before each commit

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ] || [ ! -d "core" ]; then
    print_error "This doesn't appear to be the Contextune project root directory"
    exit 1
fi

# Check if Rust is installed
if ! command -v cargo &> /dev/null; then
    print_error "Cargo is not installed. Please install Rust toolchain."
    exit 1
fi

# Check if rustfmt is available
if ! command -v rustfmt &> /dev/null; then
    print_error "rustfmt is not installed. Run: rustup component add rustfmt"
    exit 1
fi

# Check if clippy is available
if ! command -v cargo-clippy &> /dev/null; then
    print_warning "clippy is not installed. Run: rustup component add clippy"
    SKIP_CLIPPY=1
fi

echo "ðŸ“ Checking Rust code in workspace..."

# 1. Format check
echo "ðŸŽ¨ Checking Rust code formatting..."
if ! cargo fmt --all -- --check; then
    print_error "Code formatting issues found. Run 'cargo fmt --all' to fix them."
    echo ""
    echo "To automatically format your code:"
    echo "  cargo fmt --all"
    exit 1
fi
print_status "Code formatting is correct"

# 2. Clippy linting (if available)
if [ -z "$SKIP_CLIPPY" ]; then
    echo "ðŸ”§ Running Clippy lints..."
    if ! cargo clippy --all-targets --all-features -- -D warnings; then
        print_error "Clippy found issues. Please fix them before committing."
        echo ""
        echo "To see detailed clippy suggestions:"
        echo "  cargo clippy --all-targets --all-features"
        exit 1
    fi
    print_status "Clippy checks passed"
else
    print_warning "Skipping Clippy checks (not installed)"
fi

# 3. Basic compilation check
echo "ðŸ”¨ Checking if code compiles..."
if ! cargo check --all-targets --all-features; then
    print_error "Code does not compile. Please fix compilation errors."
    echo ""
    echo "Common issues:"
    echo "  - Missing dependencies or system libraries"
    echo "  - Platform-specific build configuration problems"
    echo "  - FFI export issues (check exports.map file exists)"
    echo ""
    echo "For detailed error information, run:"
    echo "  cargo check --all-targets --all-features --verbose"
    exit 1
fi
print_status "Code compiles successfully"

# 4. Run quick tests (only fast unit tests)
echo "ðŸ§ª Running quick tests..."
if ! cargo test --lib --bins --tests --quiet; then
    print_error "Some tests are failing. Please fix them before committing."
    echo ""
    echo "To run tests with detailed output:"
    echo "  cargo test --lib --bins --tests"
    exit 1
fi
print_status "Quick tests passed"

# 5. Check for common issues in staged files
echo "ðŸ“‹ Checking staged files..."

# Get list of staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$STAGED_RS_FILES" ]; then
    # Check for common issues in Rust files
    for file in $STAGED_RS_FILES; do
        if [ -f "$file" ]; then
            # Check for TODO/FIXME comments (warning only)
            if grep -n -E "(TODO|FIXME|XXX)" "$file" > /dev/null; then
                print_warning "Found TODO/FIXME comments in $file"
                grep -n -E "(TODO|FIXME|XXX)" "$file" | head -3
            fi
            
            # Check for debug prints (warning only)
            if grep -n -E "(println!|dbg!|eprintln!)" "$file" > /dev/null; then
                print_warning "Found debug prints in $file"
                grep -n -E "(println!|dbg!|eprintln!)" "$file" | head -3
            fi
            
            # Check for unsafe blocks (warning only)
            if grep -n "unsafe" "$file" > /dev/null; then
                print_warning "Found unsafe blocks in $file"
                grep -n "unsafe" "$file" | head -3
            fi
        fi
    done
fi

# 6. Check Cargo.toml files for version consistency
echo "ðŸ“¦ Checking Cargo.toml files..."
if [ -f "Cargo.toml" ]; then
    # Check if workspace Cargo.toml is properly formatted
    if ! cargo metadata --format-version 1 > /dev/null 2>&1; then
        print_error "Cargo.toml has syntax errors"
        exit 1
    fi
    print_status "Cargo.toml files are valid"
fi

# 7. Check for large files (> 1MB)
echo "ðŸ“ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} find {} -size +1M 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    print_warning "Large files detected (>1MB):"
    echo "$LARGE_FILES"
    echo "Consider using Git LFS for large files or ensure they should be committed."
fi

# 8. Security check for sensitive information
echo "ðŸ”’ Checking for sensitive information..."
STAGED_FILES=$(git diff --cached --name-only)
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for potential secrets (basic patterns)
        if grep -i -E "(password|secret|key|token|api_key)" "$file" | grep -v -E "(test|example|placeholder|dummy)" > /dev/null; then
            print_warning "Potential sensitive information found in $file"
            echo "Please review the file to ensure no secrets are being committed."
        fi
    fi
done

echo ""
print_status "All pre-commit checks passed!"
echo "ðŸš€ Ready to commit!"

exit 0